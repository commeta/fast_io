# Fast_IO - Расширение для PHP 8

## Описание

Fast_IO - это высокопроизводительное расширение для PHP 8, разработанное для эффективной работы с файлами данных. Оно предлагает набор функций для чтения, записи, обновления и удаления пар ключ-значение в файлах данных, используя низкоуровневый посекторный доступ и механизмы блокировки для синхронизации доступа. Это расширение идеально подходит для работы с большими объемами данных, обеспечивая высокую скорость и эффективность операций благодаря оптимизированному управлению памятью и дисковым вводом-выводом.

## Основные возможности

- **Быстрая запись и чтение**: Позволяет выполнять операции записи и чтения для пар ключ-значение с высокой производительностью.
- **Транзакции с блокировкой**: Использует механизм портируемой блокировки файла для обеспечения синхронизации доступа между параллельными операциями.
- **Эффективное управление памятью**: Чтение данных осуществляется порциями, что предотвращает переполнение памяти при работе с большими файлами.
- **Поддержка индексных файлов**: Улучшает производительность поиска по ключу за счет использования отдельных индексных файлов.
- **Бинарная безопасность**: Функции с префиксом index_ обеспечивают безопасную работу с бинарными данными.

## Функции расширения
- [write_key_value_pair](/docs/write_key_value_pair.md) - Запись пары ключ-значение в текстовый файл.
- [pop_key_value_pair](/docs/pop_key_value_pair.md) - Извлечение и удаление последней строки из файла.
- [rebuild_data_file](/docs/rebuild_data_file.md) - Перестройка файла данных и соответствующего индексного файла.
- [indexed_write_key_value_pair](/docs/indexed_write_key_value_pair.md) - Запись пары ключ-значение в текстовый файл данных и соответствующий индексный файл.
- [indexed_find_value_by_key](/docs/indexed_find_value_by_key.md) - Поиск значения по ключу с использованием индексного файла.
- [hide_key_value_pair](/docs/hide_key_value_pair.md) - Скрытие ключей в файлах данных.
- [find_value_by_key](/docs/find_value_by_key.md) - Поиск значения по ключу в файле данных.
- [delete_key_value_pair](/docs/delete_key_value_pair.md) - Удаление пары ключ-значение из файла данных.
- [get_index_keys](/docs/get_index_keys.md) - Извлечение уникальных ключей из текстового файла.
- [update_key_value_pair](/docs/update_key_value_pair.md) - Обновление значения по заданному ключу.
- [insert_key_value](/docs/insert_key_value.md) - Добавление строк с определённым выравниванием в файл.
- [select_key_value](/docs/select_key_value.md) - Выборка строки по указанному номеру строки и выравниванию из файла.
- [update_key_value](/docs/update_key_value.md) - Обновление значения по ключу в файле.
- [detect_align_size](/docs/detect_align_size.md) - Возвращает максимальную длину строки в файле.


## Особенности реализации

- Все функции используют UNIX портируемую блокировку файла на запись, что гарантирует целостность данных при параллельном доступе.
- Расширение разработано без использования сторонних фреймворков и библиотек, обеспечивая высокую производительность и совместимость с PHP 8.
- Функции производят чтение данных порциями, оптимизируя использование памяти и уменьшая нагрузку на систему.
- Стоимость вызовов функций с низким потреблением в случае попадания в кэш, сопоставима со скоростью доступа к памяти.

Fast_IO представляет собой мощное расширение для PHP 8, которое значительно упрощает и ускоряет работу с большими объемами данных. Благодаря эффективным механизмам чтения, записи, блокировки и управления памятью, разработчики могут создавать высокопроизводительные приложения, оптимизированные для обработки файлов данных.

## Примеры использования

Для каждой функции расширения Fast_IO предоставлены подробные описания с примерами на PHP. Эти примеры помогут разработчикам быстро начать работу с расширением и эффективно использовать его возможности в своих проектах.

## Параметры

buffer_size - это параметр конфигурации, определяющий размер буфера для операций чтения и записи. Указание оптимального размера буфера может значительно улучшить производительность при работе с большими объемами данных.

#### Установка через php.ini

Для настройки размера буфера в глобальной конфигурации PHP добавьте или измените следующую строку в файле php.ini:

fast_io.buffer_size = 4096

Значение указывается в байтах. По умолчанию размер буфера установлен равным 4096 байт (4 КБ).

#### Использование в коде PHP

Вы можете получить текущее значение buffer_size или установить новое значение в начале вашего PHP скрипта:
```
// Получить текущий размер буфера
$currentBufferSize = ini_get('fast_io.buffer_size');

// Установить новый размер буфера, до вызова функций!
ini_set('fast_io.buffer_size', 8192); // 8 КБ
```

### Примечания

- Изменение размера буфера во время выполнения скрипта может повлиять на производительность операций ввода-вывода, выполняемых после этого изменения.
- Выбор оптимального размера буфера зависит от конкретных задач и условий работы приложения. Рекомендуется проводить тестирование с различными значениями, чтобы найти наилучший вариант.
- Указывайте размер буфера ориентируясь на размер порции данных, значения по умолчанию 4096 хватит для работы со строками размером не больше 4096 байт.
- При большом размере буфера возможны лишние чтения файла, например при полнотекстовом поиске, когда значение может быть найдено в начале файла, а он будет прочитан на величину буфера.
- Значение буфера должно быть кратно странице памяти кэша 4096 байт.

---

## Установка

### Шаг 1: Создание каркаса расширения
Скопируйте файлы: `config.m4`, `fast_io.c`, `fast_io.h` в текущий каталог проекта.

Для начала, вам нужно создать каркас вашего расширения. Это можно сделать вручную или с помощью инструмента ext_skel в исходниках PHP. Например:
```
phpize
./configure
make
make test
```

Это создаст базовую структуру для вашего расширения.



### Шаг 2: Компиляция и тестирование

Вам нужно скомпилировать расширение и протестировать его. Используйте phpize, ./configure, make и make test для компиляции и установки вашего расширения.

После установки не забудьте добавить строку `extension=fast_io.so` в ваш `php.ini`, чтобы активировать расширение.

Теперь вы можете вызывать новые функции из PHP как обычные функции.

Результат тестирования: Ubuntu 24.04, Ryzen 12 Cores, 16GB RAM, SATA 3 SSD.

```
write_key_value_pair: 0.11487889289856 (0.00001149)
find_value_by_key: 1.1644461154938 (0.00011644)
find_value_by_key repeat: 0.059406042098999 (0.00000594)
delete_key_value_pair: 10.655761003494 (0.00106558)
indexed_write_key_value_pair: 0.21924114227295 (0.00002192)
indexed_find_value_by_key: 0.91544914245605 (0.00009154)
indexed_find_value_by_key repeat: 0.11506295204163 (0.00001151)
pop_key_value_pair: 0.20079398155212 (0.00002008)
```

Функция запускалась в цикле 10000 раз, с линейным инкрементом индекса (без попадания в кэш) и repeat многократный поиск одного и того же индекса.
Показано время в секундах по результатам теста: 10000 запусков (1 запуск).

## Стоимость вызовов

Таблица стоимости вызова функции по возрастанию:

- select_key_value Очень низкое потребление, посекторное чтение отрезка файла.
- update_key_value Очень низкое потребление, посекторная запись отрезка файла.
- pop_key_value_pair Низкое потребление, с выравниванием очень низкое, чтение файла с конца, усечение файла.
- write_key_value_pair Очень низкое потребление, запись строки в конец файла.
- insert_key_value Очень низкое потребление, запись строки в конец файла.
- indexed_write_key_value_pair Низкое потребление, запись строки в конец файла индекса и блока в конец файла данных.
- find_value_by_key Среднее потребление, чтение всего файла.
- detect_align_size Среднее потребление, чтение всего файла.
- get_index_keys Среднее потребление, чтение всего файла.
- hide_key_value_pair Среднее потребление, чтение всего файла, запись строки в файл.
- indexed_find_value_by_key Среднее потребление, чтение всего файла индекса и блока файла данных.
- delete_key_value_pair Высокое потребление, полное чтение\запись всего файла.
- update_key_value_pair Высокое потребление, полное чтение\запись всего файла.
- rebuild_data_file Очень высокое потребление, полное чтение\запись файлов индекса и данных.

