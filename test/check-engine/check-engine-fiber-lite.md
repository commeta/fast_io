# Асинхронный стресс-тест на Fibers (check-engine-fiber-lite.php)

**Fast_IO Async Fiber Stress Test** — лёгкая асинхронная версия многопоточного стресс-теста, построенная на **нативных PHP Fibers** (PHP 8.1+).

## Зачем нужен этот тест

- Проверяет **thread/process-safety** функций Fast_IO в условиях конкурентного доступа **внутри одного процесса**.
- Использует кооперативную многозадачность (Fibers), что делает тест значительно легче по памяти и CPU, чем `check-engine-mt-lite.php` (pcntl_fork).
- Идеально подходит для быстрой проверки стабильности расширения на CI/CD, dev-машинах и в окружениях, где `pcntl` отключён или нежелателен.

## Что тестируется

Каждый fiber выполняет случайную смесь операций:
- `file_insert_line()` (mode 2) — вставка с выравниванием
- `file_update_line()` (mode 0) — обновление одной строки
- `file_select_line()` (mode 1) — чтение одной строки
- `file_select_array()` + `file_update_array()` — пакетное чтение/обновление

Все операции выполняются **конкурентно** с обязательной блокировкой файлов (`flock`).

## Требования

- PHP 8.1 или выше (нужны Fibers)
- Установлено расширение **fast_io**
- `ini_set('fast_io.buffer_size', ...)` разрешено

## Запуск

```bash
# По умолчанию: 8 fibers × 150 итераций
php check-engine-fiber-lite.php

# Свои параметры
php check-engine-fiber-lite.php 16 300
```

Параметры:
- `workers` (1-й аргумент) — количество fibers (рекомендуется 4–24)
- `iterations` (2-й аргумент) — количество операций на fiber

### Пример успешного прохождения

```text
=== fast_io ASYNC FIBER СТРЕСС-ТЕСТ v1.0 ===
Fibers (workers)   : 12
Итераций на fiber  : 200

===============================================================================
ASYNC FIBER ТЕСТ ЗАВЕРШЁН
Время выполнения   : 4.872 сек
Неудачных fibers   : 0 / 12
Строк в файле      : 1847
Прерываний потока  : 0

✅ check-engine-fiber-lite.php — УСПЕШНО ПРОЙДЕН
Fibers работают корректно под нагрузкой (кооперативно)

Готово! Запускайте сколько угодно раз.
```

## Сравнение с многопроцессной версией

| Характеристика               | `check-engine-mt-lite.php` | `check-engine-fiber-lite.php` |
|-----------------------------|----------------------------|-------------------------------|
| Тип параллелизма            | Реальные процессы (pcntl)  | Кооперативные fibers          |
| Конкуренция                 | Максимальная               | Средняя (кооперативная)       |
| Потребление памяти          | Высокое                    | Низкое                        |
| Требует `pcntl`             | Да                         | Нет                           |
| Минимальная версия PHP      | 7.0+                       | 8.1+                          |
| Лучше всего подходит        | Максимальный стресс-тест   | Быстрая проверка / CI         |

**Рекомендация:**  
Для полноценного «боевого» тестирования используйте **многопроцессную** версию (`check-engine-mt-lite.php`).  
Для быстрой проверки и в CI/CD — **fiber-версию**.

---

