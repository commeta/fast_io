php check-memleaks.php
╔══════════════════════════════════════════════════════════════════════════════╗
║                        fast_io MEMORY LEAK TEST v2.0                         ║
╚══════════════════════════════════════════════════════════════════════════════╝

  Итераций на фазу   : 10000
  Рабочая директория : /tmp/fast_io_memleak_53612
  PHP                : 8.3.6
  fast_io загружен   : ДА
  Режим Valgrind     : нет
  keep_logs          : нет
  Порог RSS-дельты   : 8.00 MB


────────────────────────────────────────────────────────────────────────────────
  ФАЗА: PHASE 0 — Подготовка  (итераций: 500)
────────────────────────────────────────────────────────────────────────────────
  [████████████████████████████████████████] 100% 500/500   ✓ insert_line (0.006s)

✅ Подготовка — OK
     Время: 0.008s      PHP usage: 2.00 MB     PHP peak: 2.00 MB   
     PHP Δ: +0.00 MB    RSS: 28.82 MB      RSS Δ: +4 kB

────────────────────────────────────────────────────────────────────────────────
  ФАЗА: PHASE 1 — insert_line + select_line  (итераций: 10000)
────────────────────────────────────────────────────────────────────────────────
  [████████████████████████████████████████] 100% 10000/10000   ✓ insert+select (0.189s)

✅ insert+select — OK
     Время: 0.190s      PHP usage: 2.00 MB     PHP peak: 2.00 MB   
     PHP Δ: +0.00 MB    RSS: 28.82 MB      RSS Δ: +0 kB
     Рост памяти внутри фазы: 0.00 MB

────────────────────────────────────────────────────────────────────────────────
  ФАЗА: PHASE 2 — update_line + update_array  (итераций: 2000)
────────────────────────────────────────────────────────────────────────────────
  [████████████████████████████████████████] 100% 2000/2000   ✓ update_line (0.024s)

✅ update — OK
     Время: 0.030s      PHP usage: 4.00 MB     PHP peak: 4.00 MB   
     PHP Δ: +2.00 MB    RSS: 29.83 MB      RSS Δ: +1.02 MB
     Batch update_array: 2000 строк

────────────────────────────────────────────────────────────────────────────────
  ФАЗА: PHASE 3 — search_line + search_array + get_keys + pcre2  (итераций: 1000)
────────────────────────────────────────────────────────────────────────────────
  [████████████████████████████████████████] 100% 1000/1000   ✓ search+pcre2 (2.326s)

✅ search + pcre2 — OK
     Время: 2.328s      PHP usage: 4.00 MB     PHP peak: 4.00 MB   
     PHP Δ: +0.00 MB    RSS: 29.95 MB      RSS Δ: +120 kB
     4 операции/итер, 1000 итераций — рост памяти внутри: 0.00 MB

────────────────────────────────────────────────────────────────────────────────
  ФАЗА: PHASE 4 — push_data + search_data + defrag_data  (итераций: 2000)
────────────────────────────────────────────────────────────────────────────────
  [████████████████████████████████████████] 100% 2000/2000   ✓ push+search_data (0.102s)

✅ binary ops — OK
     Время: 0.108s      PHP usage: 4.00 MB     PHP peak: 4.00 MB   
     PHP Δ: +0.00 MB    RSS: 29.96 MB      RSS Δ: +8 kB

────────────────────────────────────────────────────────────────────────────────
  ФАЗА: PHASE 5 — callback_line + pop_line + replicate_file  (итераций: 500)
────────────────────────────────────────────────────────────────────────────────
  Callback вызовов: 9039
  [████████████████████████████████████████] 100% 500/500   ✓ pop_line (0.014s)

✅ callback + pop + replicate — OK
     Время: 0.019s      PHP usage: 4.00 MB     PHP peak: 4.00 MB   
     PHP Δ: +0.00 MB    RSS: 29.96 MB      RSS Δ: +0 kB

────────────────────────────────────────────────────────────────────────────────
  СНИМКИ ПО ФАЗАМ (PHP / proc)
────────────────────────────────────────────────────────────────────────────────
  Фаза   Время PHP usage    PHP peak     RSS          PSS        VmPeak  
  phase0     08:54:43   2.00 MB      2.00 MB      28.82 MB     13.37 MB   96.98 MB
  phase1     08:54:43   2.00 MB      2.00 MB      28.82 MB     13.37 MB   96.98 MB
  phase2     08:54:43   2.00 MB      2.00 MB      29.83 MB (+1.02 MB) 14.38 MB   98.94 MB
  phase3     08:54:45   4.00 MB      4.00 MB      29.95 MB (+120 kB) 14.50 MB   98.94 MB
  phase4     08:54:46   4.00 MB      4.00 MB      29.96 MB (+8 kB) 14.51 MB   98.94 MB
  phase5     08:54:46   4.00 MB      4.00 MB      29.96 MB     14.51 MB   98.94 MB
  final      08:54:46   4.00 MB      4.00 MB      29.96 MB     14.51 MB   98.94 MB
────────────────────────────────────────────────────────────────────────────────
  АНАЛИТИКА МЕТРИК
────────────────────────────────────────────────────────────────────────────────
  RSS  | min: 28.82 MB   max: 29.96 MB   mean: 29.61 MB   median: 29.95 MB  
       | stddev: 558 kB   тренд: +213.1 kB/снимок
  PSS  | min: 13.37 MB   max: 14.51 MB   mean: 14.16 MB   median: 14.50 MB  
────────────────────────────────────────────────────────────────────────────────
  ДЕЛЬТЫ start → final:
  PHP peak delta : 2.00 MB
  PHP usage final: 4.00 MB
  RSS delta      : 1.14 MB

════════════════════════════════════════════════════════════════════════════════
  ИТОГ ТЕСТА НА УТЕЧКИ ПАМЯТИ
════════════════════════════════════════════════════════════════════════════════
  Общее время     : 2.683s
  PHP peak delta  : +2.00 MB  ✅
  PHP usage final : 4.00 MB
  RSS delta (proc): +1.14 MB  ✅

✅  УТЕЧЕК ПАМЯТИ НЕ ОБНАРУЖЕНО
    Рост PHP peak < 8 MB  |  RSS delta в норме
    fast_io корректно освобождает память во всех фазах.

  Снимки и логи: /tmp/fast_io_memleak_53612
  DB-файлы будут удалены. Запустите с keep-logs=1 для сохранения.
  Тест завершён.

./check-memleaks.sh
╔══════════════════════════════════════════════════════════════════════╗
║          fast_io MEMORY LEAK WRAPPER v2.0                           ║
╚══════════════════════════════════════════════════════════════════════╝
Режим     : Valgrind
Итераций  : 4000
Скрипт    : /home/commeta/project/kernel/fast_io/check-memleaks.php
Лог       : /home/commeta/project/kernel/fast_io/check-memleaks-valgrind.log
Keep logs : NO

Проверка fast_io... ✓ загружено

Valgrind  : valgrind-3.22.0

ℹ  valgrind-php.supp не найден — PHP internals могут отображаться как 'still reachable'

Что ожидать под Valgrind:
  • RSS вырастет на 150-250 MB (Valgrind shadow memory) — это НЕ утечка
  • Скорость в 20-50x медленнее нативного PHP
  • 'still reachable' от zend/dlopen — PHP internals, норма
  • Реальные утечки: только 'definitely lost' и 'indirectly lost'

Запускаем Valgrind (30-120 секунд)...

╔══════════════════════════════════════════════════════════════════════════════╗
║                fast_io MEMORY LEAK TEST v2.0 [VALGRIND MODE]                 ║
╚══════════════════════════════════════════════════════════════════════════════╝

  Итераций на фазу   : 4000
  Рабочая директория : /tmp/fast_io_memleak_53646
  PHP                : 8.3.6
  fast_io загружен   : ДА
  Режим Valgrind     : ✅ ДА (автодетект)
  keep_logs          : нет
  Порог RSS-дельты   : 512.00 MB (VG-режим, оверхед Valgrind ~150-250 MB игнорируется)

  ℹ️  Valgrind добавляет 150-250 MB RSS overhead (shadow memory).
     Это ожидаемо и НЕ является утечкой fast_io.
     Ориентируемся на: PHP peak delta + 'definitely/indirectly lost' в VG-логе.


────────────────────────────────────────────────────────────────────────────────
  ФАЗА: PHASE 0 — Подготовка  (итераций: 500)
────────────────────────────────────────────────────────────────────────────────
  [████████████████████████████████████████] 100% 500/500   ✓ insert_line (0.422s)

✅ Подготовка — OK
     Время: 0.468s      PHP usage: 2.00 MB     PHP peak: 2.00 MB   
     PHP Δ: +0.00 MB    RSS: 226.94 MB     RSS Δ: +3.78 MB

────────────────────────────────────────────────────────────────────────────────
  ФАЗА: PHASE 1 — insert_line + select_line  (итераций: 4000)
────────────────────────────────────────────────────────────────────────────────
  [████████████████████████████████████████] 100% 4000/4000   ✓ insert+select (1.004s)

✅ insert+select — OK
     Время: 1.019s      PHP usage: 2.00 MB     PHP peak: 2.00 MB   
     PHP Δ: +0.00 MB    RSS: 248.60 MB     RSS Δ: +21.66 MB
     Рост памяти внутри фазы: 0.00 MB

────────────────────────────────────────────────────────────────────────────────
  ФАЗА: PHASE 2 — update_line + update_array  (итераций: 2000)
────────────────────────────────────────────────────────────────────────────────
  [████████████████████████████████████████] 100% 2000/2000   ✓ update_line (0.354s)

✅ update — OK
     Время: 0.455s      PHP usage: 4.00 MB     PHP peak: 4.00 MB   
     PHP Δ: +2.00 MB    RSS: 249.84 MB     RSS Δ: +1.24 MB
     Batch update_array: 2000 строк

────────────────────────────────────────────────────────────────────────────────
  ФАЗА: PHASE 3 — search_line + search_array + get_keys + pcre2  (итераций: 400)
────────────────────────────────────────────────────────────────────────────────
  [████████████████████████████████████████] 100% 400/400   ✓ search+pcre2 (17.395s)

✅ search + pcre2 — OK
     Время: 17.406s     PHP usage: 4.00 MB     PHP peak: 4.00 MB   
     PHP Δ: +0.00 MB    RSS: 251.90 MB     RSS Δ: +2.06 MB
     4 операции/итер, 400 итераций — рост памяти внутри: 0.00 MB

────────────────────────────────────────────────────────────────────────────────
  ФАЗА: PHASE 4 — push_data + search_data + defrag_data  (итераций: 800)
────────────────────────────────────────────────────────────────────────────────
  [████████████████████████████████████████] 100% 800/800   ✓ push+search_data (0.616s)

✅ binary ops — OK
     Время: 0.684s      PHP usage: 4.00 MB     PHP peak: 4.00 MB   
     PHP Δ: +0.00 MB    RSS: 252.11 MB     RSS Δ: +212 kB

────────────────────────────────────────────────────────────────────────────────
  ФАЗА: PHASE 5 — callback_line + pop_line + replicate_file  (итераций: 500)
────────────────────────────────────────────────────────────────────────────────
  Callback вызовов: 3039
  [████████████████████████████████████████] 100% 500/500   ✓ pop_line (0.184s)

✅ callback + pop + replicate — OK
     Время: 0.214s      PHP usage: 4.00 MB     PHP peak: 4.00 MB   
     PHP Δ: +0.00 MB    RSS: 252.26 MB     RSS Δ: +156 kB

────────────────────────────────────────────────────────────────────────────────
  СНИМКИ ПО ФАЗАМ (PHP / proc)
────────────────────────────────────────────────────────────────────────────────
  Фаза   Время PHP usage    PHP peak     RSS          PSS        VmPeak  
  phase0     08:55:37   2.00 MB      2.00 MB      226.94 MB    211.84 MB  318.48 MB
  phase1     08:55:38   2.00 MB      2.00 MB      248.60 MB (+21.66 MB) 233.50 MB  338.53 MB
  phase2     08:55:39   2.00 MB      2.00 MB      249.84 MB (+1.24 MB) 234.74 MB  342.59 MB
  phase3     08:55:56   4.00 MB      4.00 MB      251.90 MB (+2.06 MB) 236.75 MB  345.48 MB
  phase4     08:55:57   4.00 MB      4.00 MB      252.11 MB (+212 kB) 236.95 MB  345.50 MB
  phase5     08:55:57   4.00 MB      4.00 MB      252.26 MB (+156 kB) 237.10 MB  345.50 MB
  final      08:55:57   4.00 MB      4.00 MB      252.26 MB    237.10 MB  345.50 MB
────────────────────────────────────────────────────────────────────────────────
  АНАЛИТИКА МЕТРИК
────────────────────────────────────────────────────────────────────────────────
  RSS  | min: 226.94 MB  max: 252.26 MB  mean: 247.70 MB  median: 251.90 MB 
       | stddev: 9.27 MB  тренд: +3129.0 kB/снимок
  PSS  | min: 211.84 MB  max: 237.10 MB  mean: 232.57 MB  median: 236.75 MB 
  ⚠️  Аномалии RSS:
     • Фаза 1→2: RSS вырос на 21.66 MB
────────────────────────────────────────────────────────────────────────────────
  ДЕЛЬТЫ start → final:
  PHP peak delta : 2.00 MB
  PHP usage final: 4.00 MB
  RSS delta      : 25.32 MB
  ℹ️  RSS рост под Valgrind ожидаем (shadow memory + dlopen overhead)

════════════════════════════════════════════════════════════════════════════════
  ИТОГ ТЕСТА НА УТЕЧКИ ПАМЯТИ
════════════════════════════════════════════════════════════════════════════════
  Общее время     : 20.280s
  PHP peak delta  : +2.00 MB  ✅
  PHP usage final : 4.00 MB
  RSS delta (proc): +25.32 MB  ✅  [VG-оверхед учтён, порог 512 MB]

✅  УТЕЧЕК ПАМЯТИ НЕ ОБНАРУЖЕНО
    PHP peak delta < 8 MB  |  VG: 0 definitely/indirectly lost
    'still reachable' = PHP-рантайм (zend/dlopen), ОС освобождает при выходе

  Снимки и логи: /tmp/fast_io_memleak_53646
  DB-файлы будут удалены. Запустите с keep-logs=1 для сохранения.
  Тест завершён.


══════════════════════════════════════════════════════════════════════════
  Анализ лога Valgrind
══════════════════════════════════════════════════════════════════════════
Время выполнения : 25s
Лог              : /home/commeta/project/kernel/fast_io/check-memleaks-valgrind.log

LEAK SUMMARY (Valgrind):
   definitely lost:            0 bytes   [OK]
   indirectly lost:            0 bytes   [OK]
   possibly lost:              0 bytes   [OK]
   still reachable:        77864 bytes   [ℹ PHP internals — норма]

Ошибки памяти:
   ✅ 0 ошибок (buffer overflows, use-after-free, uninitialized reads)

Анализ 'still reachable':
   ⚠  fast_io упоминается в 1 строках — проверьте вручную:
      grep -B2 -A20 'fast_io' /home/commeta/project/kernel/fast_io/check-memleaks-valgrind.log | head -80
   ℹ  PHP/Zend internals в 46 строках — это PHP lifecycle, не fast_io

Почему RSS растёт под Valgrind:
  Valgrind выделяет ~8 байт shadow memory на каждый байт программы.
  Загрузка fast_io.so + shared libs добавляет 100-250 MB RSS.
  Это оверхед Valgrind, а не утечка fast_io.

══════════════════════════════════════════════════════════════════════════
  ФИНАЛЬНЫЙ ВЕРДИКТ
══════════════════════════════════════════════════════════════════════════

  ✅  УТЕЧЕК ПАМЯТИ В fast_io НЕ ОБНАРУЖЕНО

  definitely lost = 0, indirectly lost = 0, errors = 0
  Библиотека fast_io корректно освобождает всю выделенную память.

  ℹ  still reachable = 77864 bytes — PHP runtime, освободится при выходе

Команды для анализа:
  Полный лог:           less /home/commeta/project/kernel/fast_io/check-memleaks-valgrind.log
  Реальные утечки:      grep -E 'definitely|indirectly' /home/commeta/project/kernel/fast_io/check-memleaks-valgrind.log
  LEAK SUMMARY:         grep -A10 'LEAK SUMMARY' /home/commeta/project/kernel/fast_io/check-memleaks-valgrind.log
  Стеки fast_io:        grep -B2 -A20 'fast_io' /home/commeta/project/kernel/fast_io/check-memleaks-valgrind.log | head -100
  Ошибки памяти:        grep 'ERROR SUMMARY' /home/commeta/project/kernel/fast_io/check-memleaks-valgrind.log

