# check-engine-fiber.php — FIBER ASYNC СТРЕСС-ТЕСТ fast_io v1.0

Самый мощный тест библиотеки, подтверждающий **полную безопасность fast_io в асинхронной среде PHP 8.1+ Fibers**.

## Что проверяет тест

Тест запускает **12 параллельных Fiber-воркеров** (можно задать любое количество), каждый из которых выполняет **120 итераций** 16 критически важных операций:

| Sub-test                | Что тестируется                              |
|-------------------------|----------------------------------------------|
| `select_line` / `select_array` | Чтение по смещению и пакетное чтение        |
| `update_line` / `update_array` | Обновление одной и пакета строк             |
| `search_line` / `search_array` | Поиск по строке и PCRE2-регулярке           |
| `get_keys`              | Получение всех ключей в разных режимах      |
| `erase_line`            | Удаление по ключу                           |
| `push_search_data`      | push_data + search_data (key-value хранилище)|
| `callback_line`         | Построчный callback с возможностью jump     |
| `file_analize`          | Анализ структуры файла                      |
| `find_matches_pcre2`    | PCRE2-поиск внутри строк                    |
| `replace_line`          | Замена строки по ключу                      |
| `pop_line`              | LIFO-стек (pop с конца)                     |
| `replicate_file`        | Побитовое копирование файла                 |
| `defrag_data`           | Дефрагментация key-value хранилища          |

## Ключевые особенности реализации

- **Без fork** — всё в одном процессе (в отличие от `check-engine-mt.php`).
- **Кооперативная многозадачность** — каждый воркер делает `Fiber::suspend()` каждые 3 суб-теста.
- **Общие данные в памяти** — `$offsets_map`, `$all_results` доступны всем fibers.
- **Полная проверка консистентности** — главный поток после завершения всех fibers проверяет **каждую** из 1440 записей.
- **Детальная IO-статистика** — `/proc/<pid>/io` по каждому суб-тесту и суммарно.
- **Автоматическая очистка** — все временные файлы удаляются.

## Запуск

```bash
php check-engine-fiber.php [workers=12] [iterations=120]
```

## Пример успешного прохождения (реальный вывод)

```
Fibers (workers)     : 12
Итераций на fiber    : 120
PHP                  : 8.3.6

✅  PHASE 0 подготовка — PASS (0.0285s)
✅  PHASE 2 консистентность — PASS (0.0215s)
✅  PHASE 3 анализ — PASS (0.0005s)

SUB-TEST                W0   W1 … W11  PASS/TOTAL
select_line             ✅  ✅ … ✅   12/12
... (все 16 тестов) ...
defrag_data             ✅  ✅ … ✅   12/12

ОШИБКИ ПО ВОРКЕРАМ:
Ошибок не обнаружено ✅

Общее время выполнения: 0.115 сек
Fibers (всего/упало)      : 12 / 0
Проверено ячеек (consist.): 1440
Повреждено ячеек          : 0
Ошибок в воркерах         : 0

✅  check-engine-fiber.php — УСПЕШНО ПРОЙДЕН
    Библиотека fast_io корректно работает в fiber-среде.
    Данные консистентны. Блокировки работают верно.
```

## Почему этот тест важен

- Доказывает **отсутствие race condition** при одновременном доступе множества fibers к одному файлу.
- Проверяет корректность **внутренних блокировок** (`flock LOCK_EX`).
- Гарантирует, что `file_analize` всегда видит целостную структуру даже после тысяч конкурентных обновлений/удалений.
- Показывает реальную производительность в асинхронном PHP (577 MB/s rchar, 20 MB/s wchar на обычном SSD).

**Если тест прошёл — fast_io можно спокойно использовать в любом Fiber/Async проекте (ReactPHP, Swoole, Amp, Fibers + любой фреймворк).**

## СРАВНЕНИЕ С pcntl-ВЕРСИЕЙ


  | Аспект                     | check-engine-mt.php        | check-engine-fiber.php        |
  |----------------------------|----------------------------|-------------------------------|
  | Параллелизм                | Реальные процессы (fork)   | Кооперативные Fibers          |
  | IPC                        | JSON-файлы в $base_dir     | Общие PHP-массивы (in-memory) |
  | Результаты воркеров        | child_result() → файл      | $all_results[$wid] → RAM      |
  | Ожидание завершения        | pcntl_waitpid()            | Round-robin while(!empty())   |
  | Конкуренция                | Максимальная (ядра ОС)     | Средняя (кооперативная)       |
  | Потребление памяти         | Высокое (N копий памяти)   | Низкое (один процесс)         |
  | Требует pcntl              | Да                         | Нет                           |
  | Мин. версия PHP            | 7.0+                       | 8.1+                          |
  | Файлов теста               | 6 (main, stack, data, ...) | 3 (main, data, callback)      |
  | Суб-тесты                  | 16                         | 16 (идентичный набор)         |
  | Фазы                       | 7 (0–6)                    | 7 (0–6)                       |
  | Подходит для               | Продакшн стресс-тест       | CI/CD, dev, no-pcntl окружения|

