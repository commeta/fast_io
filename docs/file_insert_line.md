# Описание функции file_insert_line

Функция file_insert_line предназначена для добавления строк с определённым выравниванием в файл. Это может быть полезно для создания структурированных текстовых баз данных или лог-файлов, где каждая запись должна начинаться с новой строки и иметь фиксированную длину. Функция реализована на языке C и доступна в PHP через специальное расширение.


Страница описания прокта [Fast_IO Engine](https://github.com/commeta/fast_io).


## Синтаксис

int file_insert_line(string $filename, string $line[, int $line_length = strlen($line)][, int $mode = 0])


## Параметры

Функция принимает три аргумента:

- $filename (string): Путь к файлу, в который будет производиться запись.
- $line (string): Строка, которую необходимо записать в файл.
- $line_length (int, optional): Число, размер строки в файле (длину строки в символах).
- $mode (int, optional) - Режим.


#### Режимы
- 0: Режим с добавлением символа перевода строки.
- 1: Режим без добавления символа перевода строки.


##### Log mode
- +100 Log mode: Если добавить +100 к любому из вышеперечисленных режимов, функция пересчитает режим mode - 100 но не будет блокировать файл.

Режимы +100 Log mode подходят для работы с файлами журналов. Подробнее: [алгоритм реализации транзакции с помощью блокировки файла](/test/transaction/README.md).


## Возвращаемые значения

Возвращает смещение начала строки в файле данных, если запись прошла успешно.
В случае возникновения ошибки возвращается отрицательное число, указывающее на тип ошибки:

- -1: Не удалось открыть файл.
- -2: Не удалось заблокировать файл для записи.
- -3: Ошибка записи в файл.
- -8: Ошибка выделения памяти.


## Особенности работы

При подготовке строки line к записи в файл, создается временный буфер размером line_length байт, заполненный пробелами. 
Если строка len меньше или равна line_length, то строка копируется в начало буфера. Если строка len больше line_length, то строка копируется в буфер насколько поместится.
В режимах mode = 1 в конце буфера устанавливается символ перевода строки.


## Пример использования
```
<?php
$filename = "/path/to/your/file.txt";
$line = "exampleKey";
$line_length = 100; // Допустим, мы хотим, чтобы каждая строка занимала 100 символов

$result = file_insert_line($filename, $line, $line_length);

if ($result >= 0) {
    $line_number = $result / $line_length;
    echo "Запись успешно добавлена. Номер строки: $line_number";
} else {
    echo "Произошла ошибка при добавлении записи. Код ошибки: $result";
}
?>
```

Еще [пример](/test/readme.md): Тесты.

В этом примере мы пытаемся добавить строку "exampleKey" в файл file.txt, при этом каждая запись должна занимать ровно 100 символов. Если операция проходит успешно, функция вернёт номер строки, в которую была добавлена запись. В случае ошибки будет возвращён соответствующий код.

### Формат файла

Файл будет содержать данные в формате ключ-значение, разделённые пробелом, каждая пара на новой строке. Например:

```
index_0 data_insert_key_value_0
index_1 data_insert_key_value_1
index_2 data_insert_key_value_2
```


## Примечания

- Файл автоматически блокируется на время записи для предотвращения одновременного доступа.
- Если файл не существует, он будет создан.
- Длина line может быть меньше line_align. В этом случае оставшаяся часть строки будет заполнена пробелами. Если $line длиннее $line_length, строка будет обрезана до нужной длины.


## Стоимость вызова

- CPU Bound - Подготовка строки к записи с учетом выравнивания.
- IO Bound - Запись строки в конец файла.

Очень низкое потребление, запись строки в конец файла.
