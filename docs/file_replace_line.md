# Описание функции file_replace_line

Функция file_replace_line предназначена для обновления строки по заданному ключу в файле, где каждая строка представляет собой пару ключ-значение, разделённые пробелом. 
Эта функция особенно полезна для работы с простыми системами хранения на основе файлов. 
Если ключ найден, обновляется вся строка. Функция написана на языке C и доступна в PHP через расширение Fast_IO.


## Синтаксис

int file_replace_line(string $filename, string $line_key, string $line [, int $mode])

## Параметры

- **filename**: Имя файла, в котором нужно обновить пару ключ-значение.
- **line_key**: Ключ, значение которого требуется обновить.
- **line**: Новая строка для замены.
- **mode**: (int, optional) - Режим работы.


## Возвращаемые значения

- Возвращает количество строк в файле.
- Возвращает -1, если файл, указанный в параметре filename, не удаётся открыть.
- Возвращает -2, если не удаётся создать или открыть временный файл.
- Возвращает -3, если не удаётся заблокировать файлы для безопасной операции чтения/записи.
- Возвращает -4, если возникает ошибка при записи в файл.
- Возвращает -5, если возникает ошибка при изменении размера файла.
- Возвращает -8, если произошла ошибка выделения памяти.

## Пример использования в PHP

Предполагается, что данная функция экспортирована в PHP через расширение. Ниже приведён пример её вызова:
```
<?php

$filename = "path/to/your/file.txt";
$key = "sampleKey";
$newValue = "updatedValue";

$result = file_replace_line($filename, $key, $newValue);

if ($result < 0) {
    echo "Не удалось обновить пару ключ-значение. Код ошибки: $result\n";
} else {
    echo "Пара ключ-значение успешно обновлена.\n";
}

?>
```

В этом примере указывается путь к файлу с парами ключ-значение ($filename), ключ строки, которую нужно обновить ($key), и новая строка. После вызова функции проверяется возвращаемое значение, чтобы определить, была ли операция успешной.

Еще [пример](/test/readme.md): Тесты.


### Особенности работы

Функция работает с текстовыми файлами, где каждая строка представляет собой пару ключ-значение, разделенные пробелом. При замене строки функция создает временный файл, в который копируются все строки, не соответствующие указанному ключу. После завершения чтения и копирования, временный файл заменяет оригинальный, тем самым подменяя строку содержащую ключ index_key.

- В режиме mode = 0 данные из временного файла копируются обратно в файл данных, для работы в цепочке.
- В режиме mode = 1 временный файл будет переименован без обратного копирования. Если параллельная копия Fast_IO функции ожидает снятия блокировки файла, то она завершится с ошибкой блокировки.


## Примечания

- Функция работает непосредственно с файловой системой, поэтому убедитесь, что процесс PHP имеет необходимые права для чтения из файла и записи в файл.
- Важно корректно обрабатывать различные возвращаемые значения для понимания результата операции и предпринятия соответствующих действий в случае ошибок.
- Поскольку функция включает операции с файлами, стоит учитывать её влияние на производительность, особенно при работе с большими файлами или в сценариях с высокой частотой вызовов.

## Стоимость вызова

- CPU Bound - Заполнение буфера и полнотекстовый поиск в начале каждой строки.
- IO Bound - Посекторное чтение файла, запись строк во временный файл, переименование временного файла.

Сверх высокое потребление, полное чтение\запись всего файла.

## Заключение

Функция file_replace_line предоставляет простой способ управления парами ключ-значение, хранящимися в файлах, непосредственно из PHP. Понимая её параметры, возвращаемые значения и правильное использование, разработчики могут эффективно интегрировать хранение данных на основе файлов в свои PHP-приложения.
