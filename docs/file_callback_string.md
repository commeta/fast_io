# Описание функции file_callback_string

Функция file_callback_string позволяет пользователю читать файл и обрабатывать его содержимое построчно, используя заданную callback-функцию.


Страница описания прокта [Fast_IO Engine](https://github.com/commeta/fast_io).


### Синтаксис

string file_callback_string(string $filename, $callback[, int $mode = 0])


#### Параметры

- **$filename**: Путь к текстовому файлу, который необходимо проанализировать.
- **$callback**: Callback-функция, которая будет вызвана для каждой строки файла.
- **$mode** (int, optional): Режим анализа.

Номер режима анализа увеличивает количество параметров callback функции, 
по умолчанию $mode = 0 callback функции будет передан 0 параметр func_get_arg(0).


Соответственно при $mode = 1 callback функции будет передан 0 и 1 параметры (func_get_arg(0) и func_get_arg(1)). И так далее.

Переменная $dynamic_buffer может зависеть от нескольких параметров:
- При вызове функции file_callback_string() переменная $dynamic_buffer_size устанавливается размером ini_get('fast_io.buffer_size').
- Если размер файла меньше ini_get('fast_io.buffer_size') то переменная $dynamic_buffer_size равняется размеру файла.
- Если $dynamic_buffer_size < 16 то $dynamic_buffer_size = 16.
- В цикле поиска строк, переменная $dynamic_buffer_size может увеличиваться: $dynamic_buffer_size += ini_get('fast_io.buffer_size').
- Увеличение переменной $dynamic_buffer_size будет происходить на каждой итерации цикла, пока текущая строка не поместится в $dynamic_buffer.



##### Log mode
- +100 Log mode: Если добавить +100 к любому из вышеперечисленных режимов, функция пересчитает режим $mode - 100 но не будет блокировать файл.

Режимы +100 Log mode подходят для работы с файлами журналов. Подробнее: [алгоритм реализации транзакции с помощью блокировки файла](/test/transaction/README.md).


#### Возвращаемое значение file_callback_string:
- В случае успеха возвращает последнее значение возвращенное callback-функцией.
- В случае ошибки возвращает `FALSE`.

#### Возвращаемое значение callback:
- Если callback-функция возвращает строку $return_line, эта строка сохраняется и возвращается в конце работы функции file_callback_string.
- Строка $return_line передается callback функции при каждом вызове если $mode > 5.
- Если callback-функция возвращает целое число (int), функция пытается переместиться на эту позицию в файле.
- При попытке перехода в тот же кадр: (int) $position == (int) $return_position - возникнет циклический переход.
- Если callback-функция возвращает `FALSE`, чтение файла прекращается, file_callback_string возвращает $return_line.
- Если callback-функция возвращает `TRUE`, чтение файла продолжается.



#### Описание работы функции file_callback_string:
1. Функция открывает указанный файл для чтения.
2. Читает файл построчно и вызывает callback-функцию для каждой строки.


Callback функция принимает переменное число аргументов:
```
$line = func_get_arg(0); // Текущая строка в файле, string
$filename = func_get_arg(1); // Имя текущего файла, string
$line_offset = func_get_arg(2); // Смещение начала строки в файле, int
$line_length = func_get_arg(3); // Длина строки в файле, int
$line_count = func_get_arg(4); // Количество прочитанных строк, int
$position = func_get_arg(5); // Позиция начала поиска строк в файле, int
$return_line = func_get_arg(6); // Строка для возврата из функции, string
$file_size = func_get_arg(7); // Текущий размер файла, int
$dynamic_buffer_size = func_get_arg(8); // Текущий размер динамического буфера, int
$dynamic_buffer = func_get_arg(9); // Динамический буфер, string
```


Callback-функция в PHP, вызванная из расширения Fast_IO, работает в контексте глобального пространства имен PHP. 
Это означает, что ей доступны все глобальные переменные, определенные в скрипте PHP, в котором она вызывается. 
Однако область видимости переменных внутри самой callback-функции зависит от того, как эта функция определена в PHP-скрипте.

Когда вы вызываете callback-функцию с помощью call_user_function, PHP создает новый контекст исполнения для этого вызова. В этом контексте:

- Глобальные переменные: Callback-функция имеет доступ ко всем глобальным переменным, которые были определены в глобальной области видимости PHP-скрипта до момента вызова функции.
- Локальные переменные: Локальные переменные, определенные внутри callback-функции, будут доступны только внутри этой функции.
- Статические переменные: Если в callback-функции определены статические переменные, они сохранят свое значение между вызовами, но будут недоступны за пределами функции.
- Суперглобальные переменные: Суперглобальные переменные, такие как $_GET, $_POST, $_SESSION и другие, будут доступны внутри callback-функции, так как они доступны в любом месте скрипта.

Важно отметить, что если callback-функция определена как анонимная функция (замыкание), она может использовать переменные из родительской области видимости с помощью ключевого слова use. 
Это позволяет передавать в замыкание значения переменных, доступных в момент его создания.



#### Пример использования:
```
ini_set('fast_io.buffer_size', 4096);
$db_file = __DIR__ . '/fast_io.dat';

for($i=0; $i <=1; $i++){
	$str = 'index_' . $i . ' file_insert_line_' . $i;
	file_insert_line($db_file, $str, 2, 256);
}

print_r(
	unserialize(
		file_callback_string(
			$db_file,
			function () {
				$ret_val = unserialize(func_get_arg(6));
				$ret_val[] = [
					func_num_args(), // Количество аргументов переданных в функцию
					mb_strlen(func_get_arg(0)), // Длина текущей строки в файле (-1 т.к. без символа перевода строки), string
					func_get_arg(1), // Имя текущего файла, string
					func_get_arg(2), // Смещение начала строки в файле, int
					func_get_arg(3), // Длина строки в файле, int
					func_get_arg(4), // Количество прочитанных строк с нуля, int
					func_get_arg(5), // Позиция начала поиска строк в файле, int
					mb_strlen(func_get_arg(6)), // Длина строки для возврата из функции, string
					func_get_arg(7), // Текущий размер файла, int
					func_get_arg(8), // Текущий размер динамического буфера, int
					count(array_slice(explode("\n", func_get_arg(9)), 0, -1)), // Колличество строк в динамическом буфере, обрывки строк справа
				];

				//return false; // Закончить поиск
				//return true; // Продолжить поиск со следующей строки
				//return 0; // Переместится на начало файла
				
				return serialize($ret_val); // Вернуть составную строку
			}, 9
		)
	)
);
```

Результат:
```
Array
(
    [0] => Array
        (
            [0] => 10
            [1] => 255
            [2] => /home/commeta/project/kernel/fast_io/fast_io.dat
            [3] => 0
            [4] => 256
            [5] => 0
            [6] => 0
            [7] => 0
            [8] => 512
            [9] => 512
            [10] => 2
        )

    [1] => Array
        (
            [0] => 10
            [1] => 255
            [2] => /home/commeta/project/kernel/fast_io/fast_io.dat
            [3] => 256
            [4] => 256
            [5] => 1
            [6] => 0
            [7] => 167
            [8] => 512
            [9] => 512
            [10] => 2
        )

)

```

