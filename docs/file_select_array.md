# Описание функции file_select_array

Функция file_select_array предназначена для извлечения строк из текстового файла, осуществляет множественные запросы основываясь на данных косвенной адресации (смещение, размер).

Эта функция реализована на языке C и доступна в PHP через Fast_IO специальное расширение.


Функция file_select_array перебирает массив адресов переданный в параметрах вызова. Извлекает из массива смещение offset и размер size. 
Далее происходит чтение указанного блока из файла, и добавление в результирующий массив.


## Синтаксис

array file_select_array(string $filename, array $addresses[, int $mode = 0][, string $pattern])

### Параметры

- **filename** (string): Путь к файлу, из которого необходимо извлечь ключи.
- **addresses** - Массив адресов строк.
- **mode** (int, optional) - Режим.
- **pattern** - регулярное выражение, по которому будет осуществляться выборка.


#### Режимы
- 0: Обрезка пробелов справа и символа перевода строки.
- 1: Возврат сырой строки.
- 5, 6: Возврат совпадений по подстроке в каждой строке, в режиме 6 возврат сырой строки. 
- 20, 21, 22: Возврат совпадений по регулярному выражению PCRE2 в каждой строке, в режиме 21 возврат сырой строки. 
- +100 Log mode: Если добавить +100 к любому из вышеперечисленных режимов, функция пересчитает режим mode -= 100 но не будет блокировать файл.

В режиме 5 и 6 функция вернет только выборки в которых присутствует подстрока pattern. В этих режимах pattern это обычная подстрока.

В режиме 20, 21, 22 функция вернет только выборки с совпадением по регулярному выражению pattern.

Режимы +100 Log mode подходят для работы с файлами журналов.


### Возвращаемые значения

Функция возвращает ассоциативный массив

- line - Строка (в режимах 0, 1, 5, 6, 21, 22).
- matches - Подстроки совпавшие с регулярным выражением (в режиме 20, 21, 22).
- offset - Смещение строки.
- length - Длина строки.


Функция возвращает ассоциативный массив, содержащий строку line или совпадения matches.

Вслучае, если ключ не найден или произошла ошибка (например, файл не может быть прочитан), функция возвращает пустой массив или NULL.



При использовании функции чтения файла, будет использоваться внутренний буфер стандартной библиотеки ввода-вывода (stdio). 
Этот внутренний буфер называется "подстрочным буфером" и обычно применяется для оптимизации операций чтения и записи данных.

Когда вы вызываете функцию для чтения данных из файла, стандартная библиотека ввода-вывода может использовать внутренний буфер для кэширования прочитанных данных. 
Это позволяет сократить количество системных вызовов к файловой системе для операций чтения и улучшить производительность приложения.

Подстрочный буфер будет автоматически заполняться, когда данные считываются из файла, и автоматически сбрасываться при достижении определенного размера буфера или при вызове функции fflush. 
Также буфер будет сбрасываться при закрытии файла.

По умолчанию стандартная библиотека ввода-вывода обеспечивает автоматическую буферизацию для повышения производительности ввода-вывода.


## Особенности работы

При использовании функции чтения файла, будет использоваться внутренний буфер стандартной библиотеки ввода-вывода (stdio). 
Этот внутренний буфер называется "подстрочным буфером" и обычно применяется для оптимизации операций чтения и записи данных.

Когда вы вызываете функцию для чтения данных из файла, стандартная библиотека ввода-вывода может использовать внутренний буфер для кэширования прочитанных данных. 
Это позволяет сократить количество системных вызовов к файловой системе для операций чтения и улучшить производительность приложения.

Подстрочный буфер будет автоматически заполняться, когда данные считываются из файла, и автоматически сбрасываться при достижении определенного размера буфера или при вызове функции fflush. 
Также буфер будет сбрасываться при закрытии файла.

По умолчанию стандартная библиотека ввода-вывода обеспечивает автоматическую буферизацию для повышения производительности ввода-вывода.



## Примеры использования

```
for($i=0; $i <=500; $i++){
	print_r(
		file_insert_line(__DIR__ . '/fast_io1.dat', 'index_' . $i . ' file_insert_line_' . $i . ' ' . str_pad('', 92, '1234567890'), 8192) . ', '
	);
}

$array=[
	[8192,8192], // Адрес и размер строки 1 в файле
	[16384,8192], // Адрес и размер строки 2 в файле
	[24576,8192] // Адрес и размер строки 3 в файле
];

print_r([
	file_select_array(__DIR__ . '/fast_io1.dat', $array, 0)
]);
```


```
Array
(
    [0] => Array
        (
            [0] => Array
                (
                    [line] => index_1 file_insert_line_1 12345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012
                    [offset] => 8192
                    [length] => 8192
                )

            [1] => Array
                (
                    [line] => index_2 file_insert_line_2 12345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012
                    [offset] => 16384
                    [length] => 8192
                )

            [2] => Array
                (
                    [line] => index_3 file_insert_line_3 12345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012
                    [offset] => 24576
                    [length] => 8192
                )

        )

)
```



```
print_r([
	file_select_array(__DIR__ . '/fast_io1.dat', $array, 20, '\\w+_\\d+')
]);
```

```
Array
(
    [0] => Array
        (
            [0] => Array
                (
                    [matches] => Array
                        (
                            [0] => index_1
                            [1] => file_insert_line_1
                        )

                    [offset] => 8192
                    [length] => 8192
                )

            [1] => Array
                (
                    [matches] => Array
                        (
                            [0] => index_2
                            [1] => file_insert_line_2
                        )

                    [offset] => 16384
                    [length] => 8192
                )

            [2] => Array
                (
                    [matches] => Array
                        (
                            [0] => index_3
                            [1] => file_insert_line_3
                        )

                    [offset] => 24576
                    [length] => 8192
                )

        )

)

```


## Стоимость вызова

- CPU Bound - Регулярные выражения PCRE2.
- IO Bound - Посекторное чтение файла в буфер.

Среднее потребление, при линейном чтении если файл не помещается в буфер - низкое, если файл или окно файла в буфере - сверх низкое.

