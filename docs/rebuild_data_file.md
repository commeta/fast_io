# Описание функции rebuild_data_file

Функция rebuild_data_file разработана на языке C и предназначена для вызова из PHP через Fast_IO специализированное расширение. 
Эта функция выполняет перестройку файла данных и соответствующего индексного файла, удаляя данные, связанные с указанным ключом index_key, 
а также оптимизируя структуру данных для повышения эффективности доступа.

## Синтаксис

int rebuild_data_file(string $filename, string $index_key)


### Параметры

- **filename** - Путь к файлу данных, который требуется перестроить.
- **index_key** - Ключ, данные связанные с которым должны быть удалены из файла данных и индексного файла.

### Возвращаемые значения

- Возвращает 1, если перестройка прошла успешно.
- Возвращает -1, если возникла ошибка при открытии файлов.
- Возвращает -2, если произошла ошибка чтения данных.
- Возвращает -3, если произошла ошибка записи данных.

## Пример использования

Для использования функции rebuild_data_file в вашем PHP-приложении, убедитесь, что ваше окружение поддерживает необходимое расширение.
```
<?php
$filename = 'path/to/datafile';
$index_key = 'unique_key';

$result = rebuild_data_file($filename, $index_key);

if ($result == 1) {
    echo "Файл данных успешно перестроен";
} else {
    echo "Ошибка при перестройке файла: код ошибки " . $result;
}
?>
```

### Особенности работы

Функция работает путем создания временных файлов для данных и индекса, в которые копируются все данные, за исключением тех, что связаны с указанным index_key. После завершения операции временные файлы заменяют оригинальные. Это обеспечивает не только удаление ненужных данных, но и оптимизацию структуры файлов для более эффективного доступа.

1. **Создание имени индексного файла**: На основе имени оригинального файла формируется имя индексного файла путем добавления расширения .index.
2. **Открытие индексного файла**: Функция пытается открыть индексный файл для чтения. В случае неудачи работа функции прекращается.
3. **Создание временного файла**: Создается временный файл с расширением .tmp, который будет использоваться для записи данных. В случае ошибки создания временного файла функция завершает работу.
4. **Блокировка файлов**: Производится попытка блокировки индексного и временного файлов для предотвращения их изменения другими процессами во время работы функции.
5. **Чтение и обработка индексного файла**: Индексный файл читается посекторно. Для каждой строки файла извлекается информация о смещении и размере блока данных в оригинальном файле.
6. **Чтение и запись данных**: Согласно полученной информации из индексного файла, данные читаются из оригинального файла и записываются во временный файл.
7. **Замена оригинального файла**: После обработки всех записей в индексном файле временный файл переименовывается, заменяя тем самым оригинальный файл данных.


### Ограничения

- Файлы должны быть доступны для чтения и записи.
- Необходимо обеспечить достаточный размер буфера для обработки строк файла.
- Функция предполагает, что индексный файл имеет специфический формат, где каждая строка содержит ключ, смещение и размер данных.

## Заключение

Функция rebuild_data_file предоставляет мощный инструмент для оптимизации и управления файлами данных в PHP-приложениях. Использование этой функции позволяет повысить производительность приложений за счет эффективного управления данными на уровне файловой системы.
