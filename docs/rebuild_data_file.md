# Описание функции rebuild_data_file

Функция rebuild_data_file разработана на языке C и предназначена для вызова из PHP через Fast_IO специализированное расширение. 
Предназначена для перестроения файла данных и соответствующего индексного файла. Эта функция может быть полезна в ситуациях, когда необходимо очистить или обновить данные, удалив помеченные записи, не изменяя при этом порядок оставшихся данных.

## Синтаксис

int rebuild_data_file(string $filename, string $index_key)


## Параметры

- filename - строка, указывающая на путь к файлу данных, который нужно перестроить.
- index_key - необязательный параметр, строка, которая указывает ключ записи, которую следует игнорировать при перестроении. Если параметр не указан, все записи будут обработаны.

## Возвращаемые значения

- Возвращает 1, если файлы были успешно перестроены.
- Возвращает -1, если не удалось открыть один из файлов.
- Возвращает -2, если не удалось заблокировать файлы.
- Возвращает -3, если произошла ошибка чтения блока данных.
- Возвращает -4, если произошла ошибка записи блока данных.
- Возвращает -5, если не удалось заменить оригинальные файлы временными.
- 

## Пример использования

Для использования функции rebuild_data_file в вашем PHP-приложении, убедитесь, что ваше окружение поддерживает необходимое расширение.
```
<?php

$retCode = rebuild_data_file("path/to/your/datafile", "optionalIndexKey");

if ($retCode == 1) {
    echo "Файлы успешно перестроены.";
} else {
    echo "Ошибка при перестроении файлов: код ошибки $retCode.";
}

?>
```

В этом примере функция rebuild_data_file используется для перестроения файла данных datafile. Опционально, можно указать ключ индекса optionalIndexKey, который будет игнорироваться в процессе перестроения.


### Особенности работы

Функция работает путем создания временных файлов для данных и индекса, в которые копируются все данные, за исключением тех, что связаны с указанным index_key. После завершения операции временные файлы заменяют оригинальные. Это обеспечивает не только удаление ненужных данных, но и оптимизацию структуры файлов для более эффективного доступа.

1. **Создание имени индексного файла**: На основе имени оригинального файла формируется имя индексного файла путем добавления расширения .index.
2. **Открытие индексного файла**: Функция пытается открыть индексный файл для чтения. В случае неудачи работа функции прекращается.
3. **Создание временного файла**: Создается временный файл с расширением .tmp, который будет использоваться для записи данных. В случае ошибки создания временного файла функция завершает работу.
4. **Блокировка файлов**: Производится попытка блокировки индексного и временного файлов для предотвращения их изменения другими процессами во время работы функции.
5. **Чтение и обработка индексного файла**: Индексный файл читается посекторно. Для каждой строки файла извлекается информация о смещении и размере блока данных в оригинальном файле.
6. **Чтение и запись данных**: Согласно полученной информации из индексного файла, данные читаются из оригинального файла и записываются во временный файл.
7. **Замена оригинального файла**: После обработки всех записей в индексном файле временный файл переименовывается, заменяя тем самым оригинальный файл данных.


### Ограничения

- Файлы должны быть доступны для чтения и записи.
- Необходимо обеспечить достаточный размер буфера для обработки строк файла.
- Функция предполагает, что индексный файл имеет специфический формат, где каждая строка содержит ключ, смещение и размер данных.
- Функция блокирует файлы на время операции, предотвращая одновременный доступ других процессов.
- Убедитесь, что есть достаточно места на диске для создания временных файлов в процессе работы функции.
- Функция работает с бинарными данными; убедитесь, что передаваемые строки и данные корректно обрабатываются вашей системой.

## Заключение

Функция rebuild_data_file предоставляет мощный инструмент для оптимизации и управления файлами данных в PHP-приложениях. Использование этой функции позволяет повысить производительность приложений за счет эффективного управления данными на уровне файловой системы.
