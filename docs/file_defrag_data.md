# Описание функции file_defrag_data

Функция file_defrag_data разработана на языке C и предназначена для вызова из PHP через Fast_IO специализированное расширение. 
Предназначена для перестроения файла данных и соответствующего индексного файла. Эта функция может быть полезна в ситуациях, когда необходимо очистить или обновить данные, удалив помеченные записи, не изменяя при этом порядок оставшихся данных.


Страница описания прокта [Fast_IO Engine](https://github.com/commeta/fast_io).

## Синтаксис

int file_defrag_data(string $filename[, string $line_key][, int mode = 0])


## Параметры

- **$filename** *(string)*: Путь к файлу, из которого будут удалены пары ключ-значение.
- **$line_key** *(string)*: Ключ, по которому будут идентифицированы и удалены пары ключ-значение. Если не указан, функция удалит все записи, начинающиеся с специального символа (ASCII Code 127).
- **$mode** (int, optional) - Режим дефрагментации.


## Возвращаемые значения

- Возвращает количество записей удаленных при дефрагментации.
- Возвращает -1, если не удалось открыть один из файлов.
- Возвращает -2, если не удалось заблокировать файлы.
- Возвращает -4, если произошла ошибка записи блока данных.
- Возвращает -5, если не удалось изменить размер файла.
- Возвращает -6, если произошла ошибка чтения блока данных.
- Возвращает -7, если произошла ошибка парсера offset:size.
- Возвращает -8, если произошла ошибка выделения памяти.



## Пример использования

Для использования функции file_defrag_data в вашем PHP-приложении, убедитесь, что ваше окружение поддерживает необходимое расширение.
```
<?php

$retCode = file_defrag_data("path/to/your/datafile", "optionalIndexKey");

if ($retCode == 1) {
    echo "Файлы успешно дефрагментированы.";
} else {
    echo "Ошибка при перестроении файлов: код ошибки $retCode.";
}

?>
```

В этом примере функция file_defrag_data используется для дефрагментации файла данных datafile. Опционально, можно указать ключ индекса optionalIndexKey, который будет игнорироваться в процессе дефрагментации.


Еще [пример](/test/readme.md): Тесты.

### Особенности работы

Функция работает путем создания временных файлов для данных и индекса, в которые копируются все данные, за исключением тех, что связаны с указанным index_key. После завершения операции временные файлы заменяют оригинальные. Это обеспечивает не только удаление ненужных данных, но и оптимизацию структуры файлов для более эффективного доступа.

- В режиме mode = 0 данные из временного файла копируются обратно в файл данных, для работы в цепочке.
- В режиме mode = 1 временный файл будет переименован без обратного копирования. Если параллельная копия Fast_IO функции ожидает снятия блокировки файла, то она завершится с ошибкой блокировки.

Фрагментация в файле данных возникает после операции скрытия строк: file_erase_line, file_update_line или file_replace_line с установкой спецсимвола (ASCII Code 127).
Если строка индекса начинается с спецсимвола (ASCII Code 127) она будет удалена из файла.


1. **Создание имени индексного файла**: На основе имени оригинального файла формируется имя индексного файла путем добавления расширения .index.
2. **Открытие индексного файла**: Функция пытается открыть индексный файл для чтения. В случае неудачи работа функции прекращается.
3. **Создание временного файла**: Создается временный файл с расширением .tmp, который будет использоваться для записи данных. В случае ошибки создания временного файла функция завершает работу.
4. **Блокировка файлов**: Производится попытка блокировки индексного и временного файлов для предотвращения их изменения другими процессами во время работы функции.
5. **Чтение и обработка индексного файла**: Индексный файл читается посекторно. Для каждой строки файла извлекается информация о смещении и размере блока данных в оригинальном файле.
6. **Чтение и запись данных**: Согласно полученной информации из индексного файла, данные читаются из оригинального файла и записываются во временный файл.
7. **Замена оригинального файла**: После обработки всех записей в индексном файле временный файл переименовывается, заменяя тем самым оригинальный файл данных.


### Ограничения

- Файлы должны быть доступны для чтения и записи.
- Функция предполагает, что индексный файл имеет специфический формат, где каждая строка содержит ключ, смещение и размер данных.
- Функция блокирует файлы на время операции, предотвращая одновременный доступ других процессов.
- Убедитесь, что есть достаточно места на диске для создания временных файлов в процессе работы функции.
- Функция работает с бинарными данными; убедитесь, что передаваемые строки и данные корректно обрабатываются вашей системой.

## Стоимость вызова

- CPU Bound - Заполнение буфера и полнотекстовый поиск в начале каждой строки.
- IO Bound - Посекторное чтение индексного файла, запись строк во временный индексный файл, посекторное чтение файла данных, посекторная запись во временный файл данных, переименование временных файлов.

Очень высокое потребление, полное чтение\запись файлов индекса и данных.

## Заключение

Функция file_defrag_data предоставляет мощный инструмент для оптимизации и управления файлами данных в PHP-приложениях. Использование этой функции позволяет повысить производительность приложений за счет эффективного управления данными на уровне файловой системы.
