## Описание

Функция indexed_write_key_value_pair реализована на языке C и предназначена для использования в PHP через fast_io специализированное расширение. Эта функция позволяет записывать пары ключ-значение в текстовый файл данных и соответствующий индексный файл, обеспечивая блокировку обоих файлов для предотвращения одновременной записи из разных процессов.

## Синтаксис

long indexed_write_key_value_pair(string $filename, string $index_key, string $index_val)


### Параметры

- **filename** - Путь к текстовому файлу данных, в который будет произведена запись значения.
- **index_key** - Ключ, который будет использоваться для индексации значения.
- **index_val** - Значение, ассоциированное с ключом, которое будет записано в файл данных.

### Возвращаемые значения

- Возвращает 1, если запись прошла успешно.
- Возвращает -1, если не удалось открыть один из файлов.
- Возвращает -2, если не удалось установить блокировку на один из файлов.
- Возвращает -3, если произошла ошибка при записи в файл данных.

## Пример использования

Для использования этой функции необходимо, чтобы ваше PHP-окружение поддерживало соответствующее расширение.
```
<?php
$filename = 'path/to/datafile';
$key = 'unique_key';
$value = 'data_value';

$result = indexed_write_key_value_pair($filename, $key, $value);

switch ($result) {
    case 1:
        echo "Запись успешно выполнена";
        break;
    case -1:
        echo "Ошибка: не удалось открыть файл";
        break;
    case -2:
        echo "Ошибка: не удалось установить блокировку на файл";
        break;
    case -3:
        echo "Ошибка: не удалось выполнить запись в файл данных";
        break;
}
?>
```

### Формат файла

Файл данных будет содержать только значения, каждое значение на новой строке. Индексный файл будет содержать пары ключ-смещение:размер, где смещение указывает на начало значения в файле данных, а размер — длину значения. Например:

Пример содержимого файла data.txt:
```
data_write_key_value_pair_0data_write_key_value_pair_1data_write_key_value_pair_2
```

Пример содержимого файла data.txt.index:
```
index_0 0:27
index_1 27:27
index_2 54:27
```


## Ограничения

- Файлы должны быть доступны для записи.
- Блокировка файлов обеспечивает целостность данных только в рамках одного сервера. В распределённых системах может потребоваться дополнительная синхронизация.

**Описание работы функции:**

1. Функция формирует имя индексного файла, добавляя к имени основного файла суффикс .index.
2. Открывает файл данных и индексный файл в режиме чтения/записи, создает их при необходимости. Если открыть файлы не удается, функция завершает работу.
3. Производит блокировку обоих файлов для безопасной записи в многопоточной среде.
4. Определяет текущее смещение в конце файла данных, куда будет произведена запись значения.
5. Записывает значение (index_val) в файл данных.
6. Создает запись индекса (offset:size), содержащую смещение и размер записанного блока данных.
7. Записывает ключ (index_key) и информацию об индексе в индексный файл.
8. Освобождает блокировки и закрывает файлы.

**Пример использования:**

`indexed_write_key_value_pair("data", "myKey", "Значение, которое нужно сохранить");`

Этот вызов функции сохранит строку "Значение, которое нужно сохранить" в файл "data", а соответствующий ключ "myKey" вместе с информацией о смещении и размере данных будет записан в файл индекса "data.index" для быстрого поиска.

**Примечание:** Функция обеспечивает корректное закрытие файлов и освобождение ресурсов даже в случае возникновения ошибок в процессе выполнения.


## Заключение

Функция indexed_write_key_value_pair представляет собой мощный инструмент для записи и индексации данных в текстовые файлы с учётом синхронизации доступа. Это особенно важно в многопоточных и многопроцессных приложениях, где одновременная запись может привести к потере или повреждению данных. Убедитесь, что ваше PHP-окружение поддерживает необходимое расширение для использования этой функции.
