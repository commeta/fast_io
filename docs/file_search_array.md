# Описание функции file_search_array

Функция file_search_array осуществляет поиск значения по ключу в файле данных. 
Она выполняет посекторный низкоуровневый поиск и возвращает найденное значение. 
Файл читается порциями, что делает функцию эффективной для работы с большими файлами. 

Функция написана на C и доступна в PHP через специализированное расширение Fast_IO.

## Синтаксис

string file_search_array(string $filename, string $line_key[, int mode = 0][, int search_start = 0][, int search_length = 1] )


### Параметры

- **filename** - Путь к файлу, в котором будет производиться поиск.
- **line_key** - Ключ, по которому осуществляется поиск значения.
- **mode** (int, optional) - Режим поиска.
- **search_start** (int, optional) - Стартовая строка начала выборки.
- **search_limit** (int, optional) - Ограничение массива выборки.


#### Режимы поиска


- 0: Поиск line_key в каждой строке, полнотекстовый поиск, возвращает массив найденных строк.
- 1: Поиск line_key в каждой строке, полнотекстовый поиск, возвращает номер и длину найденных строк.
- 2: Поиск line_key в каждой строке, полнотекстовый поиск, возвращает смещение и длину найденных строк.
- 3: Поиск line_key в каждой строке, полнотекстовый поиск, возвращает общее количество найденных строк в файле, и количество обработанных строк.

- 6: Поиск line_key в каждой строке, тоже что и 0 только search_start содержит смещение offset начала поиска выборки в файле.
- 7: Поиск line_key в каждой строке, тоже что и 1 только search_start содержит смещение offset начала поиска выборки в файле.
- 8: Поиск line_key в каждой строке, тоже что и 2 только search_start содержит смещение offset начала поиска выборки в файле.
- 9: Поиск line_key в каждой строке, тоже что и 3 только search_start содержит смещение offset начала поиска выборки в файле.

- 10: Поиск по регулярному выражению [PCRE2](https://pcre2project.github.io/pcre2/doc/html/index.html) в каждой строке, полнотекстовый поиск, возвращает массив найденных строк.
- 11: Поиск по регулярному выражению PCRE2 в каждой строке, возвращает номер и длину найденных строк.
- 12: Поиск по регулярному выражению PCRE2 в каждой строке, возвращает смещение и длину найденных строк.
- 13: Поиск по регулярному выражению PCRE2 в каждой строке, возвращает общее количество найденных строк в файле, и количество обработанных строк.

- 16: Поиск по регулярному выражению PCRE2 в каждой строке, тоже что и 10 только search_start содержит смещение offset начала поиска выборки в файле.
- 17: Поиск по регулярному выражению PCRE2 в каждой строке, тоже что и 11 только search_start содержит смещение offset начала поиска выборки в файле.
- 18: Поиск по регулярному выражению PCRE2 в каждой строке, тоже что и 12 только search_start содержит смещение offset начала поиска выборки в файле.
- 19: Поиск по регулярному выражению PCRE2 в каждой строке, тоже что и 13 только search_start содержит смещение offset начала поиска выборки в файле.


Режимы 6,7,8,9,16,17,18,19 позволяют избежать лишних чтений файла при выборке с окном пагинации.

В этих режимах позиция начала чтения в файле устанавливается на search_start теперь это не номер строки, а смещение offset в файле.

В остальных режимах чтение файла идет всегда с нулевой позиции offset = 0, и если search_start больше нуля то функция просто пропускает строки у которых номер меньше search_start.


### Возвращаемые значения

Функция возвращает массив строк, содержащий значения, ассоциированное с найденной строкой.
Вслучае, если ключ не найден или произошла ошибка (например, файл не может быть прочитан), функция возвращает пустой массив или NULL.
Строки возвращается без конечных пробелов и символа перевода строки.

### Примеры возвращаемых массивов

```
for($i=0; $i <=500; $i++){
	print_r(
		file_insert_line(__DIR__ . '/fast_io1.dat', 'index_' . $i . ' insert_key_value_' . $i . ' ' . str_pad('', 8, '1234567890'), 8192)
	);
}
```

```
print_r([
	file_search_array(__DIR__ . '/fast_io1.dat', '\\w+_1', 10, 0, 2),
	file_search_array(__DIR__ . '/fast_io1.dat', 'index_3', 0, 0, 2)
]);

Array
(
    [0] => Array
        (
            [0] => index_1 insert_key_value_1 12345678
            [1] => index_10 insert_key_value_10 12345678
        )

    [1] => Array
        (
            [0] => index_3 insert_key_value_3 12345678
            [1] => index_30 insert_key_value_30 12345678
        )

)
```

```
print_r([
	file_search_array(__DIR__ . '/fast_io1.dat', '\\w+_1', 11, 0, 2),
	file_search_array(__DIR__ . '/fast_io1.dat', 'index_3', 1, 0, 2)
]);

Array
(
    [0] => Array
        (
            [0] => Array
                (
                    [0] => 2
                    [1] => 8192
                )

            [1] => Array
                (
                    [0] => 11
                    [1] => 8192
                )

        )

    [1] => Array
        (
            [0] => Array
                (
                    [0] => 4
                    [1] => 8192
                )

            [1] => Array
                (
                    [0] => 31
                    [1] => 8192
                )

        )

)

```

```
print_r([
	file_search_array(__DIR__ . '/fast_io1.dat', '\\w+_1', 12, 0, 2),
	file_search_array(__DIR__ . '/fast_io1.dat', 'index_3', 2, 0, 2)
]);

Array
(
    [0] => Array
        (
            [0] => Array
                (
                    [0] => 8192
                    [1] => 8192
                )

            [1] => Array
                (
                    [0] => 81920
                    [1] => 8192
                )

        )

    [1] => Array
        (
            [0] => Array
                (
                    [0] => 24576
                    [1] => 8192
                )

            [1] => Array
                (
                    [0] => 245760
                    [1] => 8192
                )

        )

)
```

```
print_r([
	file_search_array(__DIR__ . '/fast_io1.dat', '\\w+_1', 13),
	file_search_array(__DIR__ . '/fast_io1.dat', 'index_3', 3)
]);
Array
(
    [0] => Array
        (
            [0] => Array
                (
                    [0] => 111
                    [1] => 501
                )

        )

    [1] => Array
        (
            [0] => Array
                (
                    [0] => 111
                    [1] => 501
                )

        )

)

```



## Пример использования

В этом примере мы ищем значение по ключу "user_id" в файле "data.txt".
```
<?php
$filename = 'path/to/data.txt';
$key = 'user_id';

$value = file_search_array($filename, $key);

if ($value !== NULL) {
    print_r(["Найденное значение: ", $value]);
} else {
    echo "Значение не найдено или произошла ошибка";
}
?>
```

Еще [пример](/test/readme.md): Тесты.

### Формат файла

Функция предполагает, что файл содержит данные в формате "ключ значение", где каждая пара разделена новой строкой. Например:

```
index_0 data_write_key_value_pair_0
index_1 data_write_key_value_pair_1
index_2 data_write_key_value_pair_2
```


## Ограничения

- Файл должен быть доступен для чтения процессом PHP.
- Функция читает файл порциями, размер которых определяется константой BUFFER_SIZE.

## Стоимость вызова

- CPU Bound - Заполнение буфера и полнотекстовый поиск в каждой строке, регулярные выражения PCRE2.
- IO Bound - Посекторное чтение файла в буфер.

Среднее потребление, чтение всего файла в режимах.
