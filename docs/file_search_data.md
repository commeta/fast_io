# Описание функции file_search_data

Функция file_search_data реализована на языке C и предназначена для использования в PHP через Fast_IO специализированное расширение. Функция предназначена для поиска значений по ключу в больших файлах данных с использованием индексного файла. Это обеспечивает быстрый доступ к данным, минимизируя необходимость полного сканирования файла данных.


Страница описания прокта [Fast_IO Engine](https://github.com/commeta/fast_io).


## Синтаксис

string file_search_data(string $filename, string $line_key[, int position = 0])


### Параметры

- **filename** - Путь к текстовому файлу, в котором будет производиться поиск.
- **line_key** - Ключ, по которому осуществляется поиск значения.
- **position** (int, optional) - Позиция начала поиска в файле индекса.


### Возвращаемые значения

Функция возвращает строку с найденным значением, ассоциированным с указанным ключом. Если ключ не найден или произошла ошибка (например, файл не может быть открыт), функция возвращает FALSE.

## Пример использования

Для использования этой функции необходимо, чтобы ваше PHP-окружение поддерживало соответствующее расширение.
```
<?php
$filename = "path/to/data.txt";
$line_key = "someKey";

$value = file_search_data($filename, $line_key);

if ($value !== false) {
    echo "Найденное значение: $value";
} else {
    echo "Ключ не найден или произошла ошибка.";
}
```


```
<?php

$filename = "path/to/nonexistent_file.txt";
$line_key = "missingKey";

$value = file_search_data($filename, $line_key);

if ($value === false) {
    echo "Произошла ошибка: ключ не найден или файл не существует.";
} else {
    echo "Найденное значение: $value";
}
```

Еще [пример](/test/readme.md): Тесты.

### Формат файла и индекса

Файл должен содержать данные в формате ключ-значение, разделённые пробелами, каждая пара на новой строке. Для каждого такого файла должен быть создан индексный файл (filename.index), содержащий смещения и размеры значений для каждого ключа в формате ключ:смещение:размер.

Пример содержимого файла data.txt:

```
data_write_key_value_pair_0data_write_key_value_pair_1data_write_key_value_pair_2
```

Пример содержимого файла data.txt.index:
```
index_0 0:27
index_1 27:27
index_2 54:27
```

**Описание работы функции:**

1. Функция формирует имя индексного файла, добавляя к имени основного файла суффикс .index.
2. Открывает индексный файл и файл данных только для чтения.
3. Производит блокировку обоих файлов для безопасного чтения в многопоточной среде.
4. Читает индексный файл блоками фиксированного размера, ищет совпадение заданного ключа с ключами в индексном файле.
5. При нахождении совпадения извлекает информацию о смещении и размере данных в файле данных.
6. Считывает данные указанного размера из файла данных, начиная с найденного смещения.
7. Добавляет нуль-терминатор к полученным данным и возвращает указатель на строку с результатом.
8. Освобождает блокировки и закрывает файлы.


## Ограничения

- Файл и его индексный файл должны быть доступны для чтения.
- Ключ и значение в файле должны быть разделены одним пробелом.
- Индексный файл должен быть корректно сформирован и соответствовать основному файлу данных.

## Стоимость вызова

- CPU Bound - Заполнение буфера и полнотекстовый поиск в начале каждой строки.
- IO Bound - Посекторное чтение файла индекса и отрезка файла данных в буфер.

Среднее потребление, чтение всего файла индекса и блока файла данных.

## Заключение

Функция file_search_data представляет собой мощный инструмент для эффективного поиска данных в больших текстовых файлах. Благодаря использованию индексных файлов, время поиска значительно сокращается по сравнению с линейным поиском. Убедитесь, что ваше PHP-окружение поддерживает необходимое расширение для использования этой функции.
