# Описание функции file_get_keys

Функция file_get_keys предназначена для извлечения ключей или данных о косвенной адресации текстового файла, где каждая строка содержит пары ключ-значение, разделенные пробелом.

Эта функция реализована на языке C и доступна в PHP через Fast_IO специальное расширение.

Функция file_get_keys проходит по всему файлу, читая его содержимое и извлекая ключи из каждой строки. Ключи собираются в массив. Результатом работы функции является массив ключей.


Страница описания прокта [Fast_IO Engine](https://github.com/commeta/fast_io).


## Синтаксис

array file_get_keys(string $filename[, int search_start = 0][, int search_length = 1][, int position = 0][, int mode = 0])

### Параметры

- **filename** (string): Путь к файлу, из которого необходимо извлечь ключи.
- **search_start** (int, optional) - Стартовая строка начала выборки.
- **search_limit** (int, optional) - Ограничение массива выборки.
- **position** (int, optional) - Позиция начала поиска в файле.
- **mode** (int, optional) - Режим поиска.


#### Режимы поиска

- 0: Возвращает ассоциативный массив: key, line_offset, line_length, line_count.
- 1: Возвращает ассоциативный массив: line, line_offset, line_length, line_count.
- 2: Возвращает ассоциативный массив: trim_line, trim_length, line_offset, line_length, line_count.
- 3: Возвращает ассоциативный массив: line_offset, line_length, line_count.

##### Log mode
- +100 Log mode: Если добавить +100 к любому из вышеперечисленных режимов, функция пересчитает режим mode - 100 но не будет блокировать файл.

Режимы +100 Log mode подходят для работы с файлами журналов. Подробнее: [алгоритм реализации транзакции с помощью блокировки файла](/test/transaction/README.md).

### Возвращаемое значение


Функция возвращает ассоциативный массив
- key - Ключ строки (начало строки до первого пробела)
- line - Строка.
- trim_line - Строка без пробелов справа и символа перевода строки.
- trim_length - Длина обрезанной строки.
- line_offset - Смещение строки (с учетом смещения начала поиска в файле).
- line_length - Длина строки.
- line_count - Счетчик строк от начала поиска.


Чтение по смещению позиции position позволяет избежать лишних чтений файла при выборке с окном пагинации.
Может потребоваться для пагинации таблицы ключей или пагинации таблицы распределения косвенной адресации строк в файле.

Чтение файла идет всегда с нулевой позиции position = 0, и если search_start больше нуля то функция просто пропускает строки у которых номер меньше search_start.


### Примеры возвращаемых массивов

```
for($i=0; $i <=500; $i++){
	print_r(
		file_insert_line(__DIR__ . '/fast_io1.dat', 'index_' . $i . ' insert_line_' . $i . ' ' . str_pad('', 8, '1234567890'), 8192)
	);
}

```


```
print_r([
	file_get_keys(__DIR__ . '/fast_io1.dat', 0, 2, 0, 0),
]);

Array
(
    [0] => Array
        (
            [0] => Array
                (
                    [key] => index_0
                    [line_offset] => 0
                    [line_length] => 8192
                    [line_count] => 1
                )
            [1] => Array
                (
                    [key] => index_1
                    [line_offset] => 8192
                    [line_length] => 8192
                    [line_count] => 2
                )
        )
)
```


```
print_r([
	file_get_keys(__DIR__ . '/fast_io1.dat', 0, 2, 0, 2),
]);

Array
(
    [0] => Array
        (
            [0] => Array
                (
                    [trim_line] => index_0 file_insert_line_0 12345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012
                    [trim_length] => 8192
                    [line_offset] => 0
                    [line_length] => 8192
                    [line_count] => 1
                )
            [1] => Array
                (
                    [trim_line] => index_1 file_insert_line_1 12345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012
                    [trim_length] => 8192
                    [line_offset] => 8192
                    [line_length] => 8192
                    [line_count] => 2
                )
        )
)
```



Еще [пример](/test/readme.md): Тесты.

## Замечания

- Файл должен быть доступен для чтения процессом, выполняющим PHP-скрипт.
- В случае ошибки при открытии файла или его блокировке, функция вернет пустой массив.
- Функция не чувствительна к регистру ключей и возвращает их в том виде, в каком они представлены в файле.


## Стоимость вызова

- CPU Bound - Заполнение буфера и полнотекстовый поиск в начале каждой строки.
- IO Bound - Посекторное чтение файла в буфер.

Среднее потребление, чтение всего файла.
